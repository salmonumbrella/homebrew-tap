name: Generate Formula

on:
  repository_dispatch:
    types: [update-formula]
  workflow_dispatch:
    inputs:
      repo:
        description: 'Source repo (e.g., salmonumbrella/deel-cli)'
        required: true
        type: string
      version:
        description: 'Version tag (e.g., v0.2.3)'
        required: true
        type: string
      binary_name:
        description: 'Binary name (e.g., deel)'
        required: true
        type: string
      formula_name:
        description: 'Formula name (e.g., deel-cli)'
        required: true
        type: string
      description:
        description: 'CLI description'
        required: true
        type: string
      archive_prefix:
        description: 'Archive name prefix (e.g., deel for deel_0.2.3_darwin_arm64.tar.gz)'
        required: true
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set variables from dispatch
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "repo=${{ github.event.client_payload.repo }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "binary_name=${{ github.event.client_payload.binary_name }}" >> $GITHUB_OUTPUT
            echo "formula_name=${{ github.event.client_payload.formula_name }}" >> $GITHUB_OUTPUT
            echo "description=${{ github.event.client_payload.description }}" >> $GITHUB_OUTPUT
            echo "archive_prefix=${{ github.event.client_payload.archive_prefix }}" >> $GITHUB_OUTPUT
          else
            echo "repo=${{ inputs.repo }}" >> $GITHUB_OUTPUT
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "binary_name=${{ inputs.binary_name }}" >> $GITHUB_OUTPUT
            echo "formula_name=${{ inputs.formula_name }}" >> $GITHUB_OUTPUT
            echo "description=${{ inputs.description }}" >> $GITHUB_OUTPUT
            echo "archive_prefix=${{ inputs.archive_prefix }}" >> $GITHUB_OUTPUT
          fi

      - name: Generate formula
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ steps.vars.outputs.repo }}
          VERSION: ${{ steps.vars.outputs.version }}
          BINARY_NAME: ${{ steps.vars.outputs.binary_name }}
          FORMULA_NAME: ${{ steps.vars.outputs.formula_name }}
          DESCRIPTION: ${{ steps.vars.outputs.description }}
          ARCHIVE_PREFIX: ${{ steps.vars.outputs.archive_prefix }}
        run: |
          VERSION_NUM="${VERSION#v}"

          # Convert formula-name to FormulaName (PascalCase)
          CLASS_NAME=$(echo "$FORMULA_NAME" | sed -E 's/(^|-)([a-z])/\U\2/g')

          # Fetch checksums for all architectures
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"

          get_sha() {
            local file="$1"
            curl -sL "${BASE_URL}/${file}" | sha256sum | cut -d' ' -f1
          }

          SHA_DARWIN_ARM64=$(get_sha "${ARCHIVE_PREFIX}_${VERSION_NUM}_darwin_arm64.tar.gz")
          SHA_DARWIN_AMD64=$(get_sha "${ARCHIVE_PREFIX}_${VERSION_NUM}_darwin_amd64.tar.gz")
          SHA_LINUX_ARM64=$(get_sha "${ARCHIVE_PREFIX}_${VERSION_NUM}_linux_arm64.tar.gz")
          SHA_LINUX_AMD64=$(get_sha "${ARCHIVE_PREFIX}_${VERSION_NUM}_linux_amd64.tar.gz")

          # Generate the formula
          cat > "Formula/${FORMULA_NAME}.rb" << EOF
          class ${CLASS_NAME} < Formula
            desc "${DESCRIPTION}"
            homepage "https://github.com/${REPO}"
            version "${VERSION_NUM}"
            license "MIT"

            on_macos do
              on_arm do
                url "${BASE_URL}/${ARCHIVE_PREFIX}_${VERSION_NUM}_darwin_arm64.tar.gz"
                sha256 "${SHA_DARWIN_ARM64}"
              end
              on_intel do
                url "${BASE_URL}/${ARCHIVE_PREFIX}_${VERSION_NUM}_darwin_amd64.tar.gz"
                sha256 "${SHA_DARWIN_AMD64}"
              end
            end

            on_linux do
              on_arm do
                url "${BASE_URL}/${ARCHIVE_PREFIX}_${VERSION_NUM}_linux_arm64.tar.gz"
                sha256 "${SHA_LINUX_ARM64}"
              end
              on_intel do
                url "${BASE_URL}/${ARCHIVE_PREFIX}_${VERSION_NUM}_linux_amd64.tar.gz"
                sha256 "${SHA_LINUX_AMD64}"
              end
            end

            def install
              bin.install "${BINARY_NAME}"
            end

            test do
              system "#{bin}/${BINARY_NAME}", "--help"
            end
          end
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "Formula/${{ steps.vars.outputs.formula_name }}.rb"
          git diff --staged --quiet || git commit -m "Update ${{ steps.vars.outputs.formula_name }} to ${{ steps.vars.outputs.version }}"
          git push
