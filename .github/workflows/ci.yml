name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Tap checked out repository (avoid API / stale tap content)
        run: |
          set -euo pipefail

          TAP_USER="${GITHUB_REPOSITORY%/*}"
          TAP_REPO="${GITHUB_REPOSITORY#*/}"
          TAP_REPO="${TAP_REPO#homebrew-}" # homebrew-tap -> tap
          TAP="$TAP_USER/$TAP_REPO"

          brew tap --custom-remote "$TAP" "$GITHUB_WORKSPACE"

      - name: Audit formulas
        run: |
          set -e
          TAP_USER="${GITHUB_REPOSITORY%/*}"
          TAP_REPO="${GITHUB_REPOSITORY#*/}"
          TAP_REPO="${TAP_REPO#homebrew-}"
          TAP="$TAP_USER/$TAP_REPO"

          brew audit --strict --tap "$TAP" --display-filename

      - name: Test formulas (style only)
        # brew style reports Sorbet/BlockMethodDefinition false positives on
        # multi-arch platform blocks; brew audit --strict (above) is the
        # authoritative check, so style is advisory only
        continue-on-error: true
        run: |
          set -e
          for formula in Formula/*.rb; do
            brew style "$formula"
          done
